<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å“ªå’å†²æ¦œè®¡åˆ’</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .movie-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .text-primary {
            color: #0d6efd !important;
        }
        .text-success {
            color: #198754 !important;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        .rank-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        @media (max-width: 576px) {
            #top20-list .list-group-item {
                flex-direction: column;
                align-items: flex-start;
            }
            #top20-list .list-group-item > div {
                width: 100%;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é”™è¯¯æç¤º -->
        <div id="error-message" class="alert alert-danger mb-4" style="display: none;"></div>

        <h1 class="mb-4">å°å“ªå’å†²æ¦œè®¡åˆ’</h1>
        
        <!-- å“ªå’ç¥¨æˆ¿è¯¦æƒ… -->
        <div class="card movie-card">
            <div class="card-body">
                <h2 class="card-title mb-4">å“ªå’ä¹‹é­”ç«¥é—¹æµ·</h2>
                <div class="row g-4">
                    <div class="col-12 col-md-6">
                        <div class="bg-light p-3 rounded">
                            <p class="text-muted mb-1">å…¨çƒæ€»ç¥¨æˆ¿</p>
                            <h2 class="text-primary mb-0" id="total-boxoffice">-</h2>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="bg-light p-3 rounded">
                            <p class="text-muted mb-1">å½“å‰æ’å</p>
                            <h2 class="text-success mb-0" id="rank">-</h2>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="bg-light p-3 rounded">
                            <p class="text-muted mb-1">è·ç¦»å‰ä¸€åå·®è·</p>
                            <h4 class="text-danger mb-0" id="boxoffice-difference">-</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¨çƒç¥¨æˆ¿ Top 10 åˆ—è¡¨ -->
        <div class="card movie-card mt-4">
            <div class="card-body">
                <h3 class="card-title mb-3">å…¨çƒç¥¨æˆ¿ Top 10</h3>
                <ul class="list-group" id="top20-list">
                    <!-- åˆ—è¡¨é¡¹å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // å…¨å±€é…ç½®
        const API_ENDPOINT = 'https://maoyan.qwe.tech/api/maoyan';
        const NEZHA_MOVIE_ID = 1294273;
        const REFRESH_INTERVAL = 1000;

        // åº”ç”¨çŠ¶æ€
        let globalData = null;
        let fetchInterval = null;

        // ä¸»æ•°æ®è·å–å‡½æ•°
        async function fetchGlobalBoxOffice() {
            try {
                const response = await axios.get(API_ENDPOINT);
                
                if (!validateResponse(response)) {
                    throw new Error('Invalid API response structure');
                }

                globalData = processRawData(response.data.data);
                hideError();
                updateUI();
            } catch (error) {
                handleError(error);
            }
        }

        // æ•°æ®æ ¡éªŒ
        function validateResponse(response) {
            return response.data && 
                   Array.isArray(response.data.data) &&
                   response.data.data.every(item => 
                       item.movieId &&
                       item.movieName &&
                       typeof item.rawValue === 'number'
                   );
        }

        // æ•°æ®å¤„ç†
        function processRawData(data) {
            return data.map((item, index) => ({
                ...item,
                rank: index + 1,
                formattedValue: item.rawValue  + ' å…ƒ'
            }));
        }

        // æ›´æ–°ç•Œé¢
        function updateUI() {
            const nezhaData = globalData.find(item => item.movieId === NEZHA_MOVIE_ID);
            
            if (nezhaData) {
                updateNezhaDetails(nezhaData);
                updateRankingDifference(nezhaData.rank);
            }
            
            if (shouldUpdateList()) {
                renderTop10List();
            }
        }

        // æ›´æ–°å“ªå’è¯¦æƒ…
        function updateNezhaDetails(data) {
            document.getElementById('total-boxoffice').textContent = data.formattedValue;
            document.getElementById('rank').textContent = data.rank;
        }

        // æ›´æ–°æ’åå·®è·ï¼ˆæ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†ï¼‰
        function updateRankingDifference(currentRank) {
            const differenceElement = document.getElementById('boxoffice-difference');
            
            if (currentRank <= 1) {
                differenceElement.textContent = 'å½“å‰å·²æ˜¯ç¬¬ä¸€å ğŸ‰';
                return;
            }

            const currentMovie = globalData.find(m => m.rank === currentRank);
            const prevMovie = globalData.find(m => m.rank === currentRank - 1);

            if (currentMovie && prevMovie) {
                const difference = prevMovie.rawValue - currentMovie.rawValue;
                differenceElement.textContent = `${difference.toLocaleString()} å…ƒ`;
            } else {
                differenceElement.textContent = 'æ•°æ®æš‚ä¸å¯ç”¨';
            }
        }

        // æ¸²æŸ“Top10åˆ—è¡¨
        function renderTop10List() {
            const listElement = document.getElementById('top20-list');
            listElement.innerHTML = globalData
                .slice(0, 10)
                .map(movie => `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge rank-badge bg-secondary me-2">#${movie.rank}</span>
                                ${movie.movieName}
                                <small class="text-muted">(${movie.releaseTime})</small>
                            </div>
                            <span class="badge bg-primary">${movie.formattedValue}</span>
                        </div>
                    </li>
                `)
                .join('');
        }

        // é”™è¯¯å¤„ç†
        function handleError(error) {
            console.error('API Error:', error);
            showError('æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨ååˆ·æ–°é¡µé¢');
        }

        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent = message;
            el.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            fetchGlobalBoxOffice();
            fetchInterval = setInterval(fetchGlobalBoxOffice, REFRESH_INTERVAL);
        });

        // æ¸…ç†
        window.addEventListener('beforeunload', () => {
            clearInterval(fetchInterval);
        });
    </script>
</body>
</html>
