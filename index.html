<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小哪吒冲榜计划</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .movie-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .text-primary {
            color: #0d6efd !important;
        }
        .text-success {
            color: #198754 !important;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        .rank-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        @media (max-width: 576px) {
            #top20-list .list-group-item {
                flex-direction: column;
                align-items: flex-start;
            }
            #top20-list .list-group-item > div {
                width: 100%;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 错误提示 -->
        <div id="error-message" class="alert alert-danger mb-4" style="display: none;"></div>

        <h1 class="mb-4">小哪吒冲榜计划</h1>
        
        <!-- 哪吒票房详情 -->
        <div class="card movie-card">
            <div class="card-body">
                <h2 class="card-title mb-4">哪吒之魔童闹海</h2>
                <div class="row g-4">
                    <div class="col-12 col-md-6">
                        <div class="bg-light p-3 rounded">
                            <p class="text-muted mb-1">全球总票房</p>
                            <h2 class="text-primary mb-0" id="total-boxoffice">-</h2>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="bg-light p-3 rounded">
                            <p class="text-muted mb-1">当前排名</p>
                            <h2 class="text-success mb-0" id="rank">-</h2>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="bg-light p-3 rounded">
                            <p class="text-muted mb-1">距离前一名差距</p>
                            <h4 class="text-danger mb-0" id="boxoffice-difference">-</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 全球票房 Top 10 列表 -->
        <div class="card movie-card mt-4">
            <div class="card-body">
                <h3 class="card-title mb-3">全球票房 Top 10</h3>
                <ul class="list-group" id="top20-list">
                    <!-- 列表项将由 JavaScript 动态生成 -->
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 全局配置
        const API_ENDPOINT = 'https://maoyan.qwe.tech/api/maoyan';
        const NEZHA_MOVIE_ID = 1294273;
        const REFRESH_INTERVAL = 1000;

        // 应用状态
        let globalData = null;
        let fetchInterval = null;

        // 主数据获取函数
        async function fetchGlobalBoxOffice() {
            try {
                const response = await axios.get(API_ENDPOINT);
                
                if (!validateResponse(response)) {
                    throw new Error('Invalid API response structure');
                }

                globalData = processRawData(response.data.data);
                hideError();
                updateUI();
            } catch (error) {
                handleError(error);
            }
        }

        // 数据校验
        function validateResponse(response) {
            return response.data && 
                   Array.isArray(response.data.data) &&
                   response.data.data.every(item => 
                       item.movieId &&
                       item.movieName &&
                       typeof item.rawValue === 'number'
                   );
        }

        // 数据处理
        function processRawData(data) {
            return data.map((item, index) => ({
                ...item,
                rank: index + 1,
                formattedValue: item.rawValue  + ' 元'
            }));
        }

        // 更新界面
        function updateUI() {
            const nezhaData = globalData.find(item => item.movieId === NEZHA_MOVIE_ID);
            
            if (nezhaData) {
                updateNezhaDetails(nezhaData);
                updateRankingDifference(nezhaData.rank);
            }
            
            if (shouldUpdateList()) {
                renderTop10List();
            }
        }

        // 更新哪吒详情
        function updateNezhaDetails(data) {
            document.getElementById('total-boxoffice').textContent = data.formattedValue;
            document.getElementById('rank').textContent = data.rank;
        }

        // 更新排名差距（核心修改部分）
        function updateRankingDifference(currentRank) {
            const differenceElement = document.getElementById('boxoffice-difference');
            
            if (currentRank <= 1) {
                differenceElement.textContent = '当前已是第一名 🎉';
                return;
            }

            const currentMovie = globalData.find(m => m.rank === currentRank);
            const prevMovie = globalData.find(m => m.rank === currentRank - 1);

            if (currentMovie && prevMovie) {
                const difference = prevMovie.rawValue - currentMovie.rawValue;
                differenceElement.textContent = `${difference.toLocaleString()} 元`;
            } else {
                differenceElement.textContent = '数据暂不可用';
            }
        }

        // 渲染Top10列表
        function renderTop10List() {
            const listElement = document.getElementById('top20-list');
            listElement.innerHTML = globalData
                .slice(0, 10)
                .map(movie => `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge rank-badge bg-secondary me-2">#${movie.rank}</span>
                                ${movie.movieName}
                                <small class="text-muted">(${movie.releaseTime})</small>
                            </div>
                            <span class="badge bg-primary">${movie.formattedValue}</span>
                        </div>
                    </li>
                `)
                .join('');
        }

        // 错误处理
        function handleError(error) {
            console.error('API Error:', error);
            showError('数据更新失败，请稍后刷新页面');
        }

        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent = message;
            el.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            fetchGlobalBoxOffice();
            fetchInterval = setInterval(fetchGlobalBoxOffice, REFRESH_INTERVAL);
        });

        // 清理
        window.addEventListener('beforeunload', () => {
            clearInterval(fetchInterval);
        });
    </script>
</body>
</html>
