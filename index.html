<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小哪吒冲榜计划</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background: #f8f9fa;
            padding: 2rem 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .header-logo {
            height: 60px;
            margin-right: 1rem;
        }

        .movie-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .value-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #dc3545;
        }

        .stats-icon {
            width: 40px;
            margin-right: 1rem;
        }

        .rank-badge {
            background: #0d6efd;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex align-items-center mb-4">
            <img src="https://blog.tengzhou.ren/web/logo.png" 
                 alt="哪吒Logo" 
                 class="header-logo">
            <h1 class="text-danger mb-0">小哪吒冲榜计划</h1>
        </div>

        <div class="movie-card">
            <div class="card-body">
                <h3 class="d-flex align-items-center mb-4">
                    <img src="https://blog.tengzhou.ren/web/icon.png" 
                         class="stats-icon"
                         alt="票房图标">
                    实时票房数据
                </h3>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="mb-4">
                            <p class="text-muted mb-1">全球总票房</p>
                            <div class="value-display" id="total-boxoffice">-</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-4">
                            <p class="text-muted mb-1">当前排名</p>
                            <div class="value-display" id="rank">-</div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div>
                            <p class="text-muted mb-1">距离前一名差距</p>
                            <div class="value-display" id="boxoffice-difference">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="movie-card">
            <div class="card-body">
                <h3 class="mb-3">全球票房 TOP10</h3>
                <ul class="list-group" id="top20-list"></ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_ENDPOINT = 'https://maoyan.qwe.tech/api/maoyan';
        const NEZHA_ID = 1294273;

        let globalData = null;
        let previousTop10 = [];

        // 核心函数
        async function fetchData() {
            try {
                const res = await axios.get(API_ENDPOINT);
                if (!res.data?.data) throw new Error('数据格式错误');
                
                globalData = res.data.data.map((item, index) => ({
                    ...item,
                    rank: index + 1,
                    formatted: formatNumber(item.rawValue)
                }));
                
                updateDisplay();
            } catch (err) {
                console.error('请求失败:', err);
                alert('数据加载失败，请稍后刷新');
            }
        }

        function updateDisplay() {
            // 哪吒数据
            const nezha = globalData.find(m => m.movieId === NEZHA_ID);
            if (nezha) {
                document.getElementById('total-boxoffice').textContent = `${nezha.formatted}元`;
                document.getElementById('rank').textContent = nezha.rank;
                updateDifference(nezha.rank);
            }

            // TOP10列表
            if (shouldUpdate()) {
                renderTop10();
            }
        }

        function updateDifference(rank) {
            const element = document.getElementById('boxoffice-difference');
            if (rank <= 1) {
                element.textContent = "已是第一名!";
                return;
            }

            const current = globalData.find(m => m.rank === rank);
            const prev = globalData.find(m => m.rank === rank - 1);
            if (current && prev) {
                const diff = prev.rawValue - current.rawValue;
                element.textContent = `${formatNumber(diff)}元`;
            }
        }

        function renderTop10() {
            const list = document.getElementById('top20-list');
            list.innerHTML = globalData.slice(0, 10).map(m => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="rank-badge me-3">#${m.rank}</span>
                        ${m.movieName}
                    </div>
                    <span class="badge bg-primary">${m.formatted}元</span>
                </li>
            `).join('');
        }

        // 工具函数
        function formatNumber(num) {
            return num.toLocaleString('zh-CN');
        }

        function shouldUpdate() {
            const currentIds = globalData.slice(0, 10).map(m => m.movieId);
            const changed = JSON.stringify(currentIds) !== JSON.stringify(previousTop10);
            previousTop10 = currentIds;
            return changed;
        }

        // 初始化
        fetchData();
        setInterval(fetchData, 1000);
    </script>
</body>
</html>
